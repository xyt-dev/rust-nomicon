# Łɛǟӄɨռɢ

Øառɛʀֆɦɨք-ɮǟֆɛɖ ʀɛֆօʊʀƈɛ ʍǟռǟɢɛʍɛռȶ ɨֆ ɨռȶɛռɖɛɖ ȶօ ֆɨʍքʟɨʄʏ ƈօʍքօֆɨȶɨօռ. Ƴօʊ
ǟƈզʊɨʀɛ ʀɛֆօʊʀƈɛֆ աɦɛռ ʏօʊ ƈʀɛǟȶɛ ȶɦɛ օɮʝɛƈȶ, ǟռɖ ʏօʊ ʀɛʟɛǟֆɛ ȶɦɛ ʀɛֆօʊʀƈɛֆ աɦɛռ
ɨȶ ɢɛȶֆ ɖɛֆȶʀօʏɛɖ. Ֆɨռƈɛ ɖɛֆȶʀʊƈȶɨօռ ɨֆ ɦǟռɖʟɛɖ ʄօʀ ʏօʊ, ɨȶ ʍɛǟռֆ ʏօʊ ƈǟռ'ȶ
ʄօʀɢɛȶ ȶօ ʀɛʟɛǟֆɛ ȶɦɛ ʀɛֆօʊʀƈɛֆ, ǟռɖ ɨȶ ɦǟքքɛռֆ ǟֆ ֆօօռ ǟֆ քօֆֆɨɮʟɛ! Ֆʊʀɛʟʏ ȶɦɨֆ
ɨֆ քɛʀʄɛƈȶ ǟռɖ ǟʟʟ օʄ օʊʀ քʀօɮʟɛʍֆ ǟʀɛ ֆօʟʋɛɖ.

Ɛʋɛʀʏȶɦɨռɢ ɨֆ ȶɛʀʀɨɮʟɛ ǟռɖ աɛ ɦǟʋɛ ռɛա ǟռɖ ɛӼօȶɨƈ քʀօɮʟɛʍֆ ȶօ ȶʀʏ ȶօ ֆօʟʋɛ.

Ɱǟռʏ քɛօքʟɛ ʟɨӄɛ ȶօ ɮɛʟɨɛʋɛ ȶɦǟȶ Ʀʊֆȶ ɛʟɨʍɨռǟȶɛֆ ʀɛֆօʊʀƈɛ ʟɛǟӄֆ. Ɨռ քʀǟƈȶɨƈɛ,
ȶɦɨֆ ɨֆ ɮǟֆɨƈǟʟʟʏ ȶʀʊɛ. Ƴօʊ աօʊʟɖ ɮɛ ֆʊʀքʀɨֆɛɖ ȶօ ֆɛɛ ǟ Ֆǟʄɛ Ʀʊֆȶ քʀօɢʀǟʍ
ʟɛǟӄ ʀɛֆօʊʀƈɛֆ ɨռ ǟռ ʊռƈօռȶʀօʟʟɛɖ աǟʏ.

Ӈօաɛʋɛʀ ʄʀօʍ ǟ ȶɦɛօʀɛȶɨƈǟʟ քɛʀֆքɛƈȶɨʋɛ ȶɦɨֆ ɨֆ ǟɮֆօʟʊȶɛʟʏ ռօȶ ȶɦɛ ƈǟֆɛ, ռօ
ʍǟȶȶɛʀ ɦօա ʏօʊ ʟօօӄ ǟȶ ɨȶ. Ɨռ ȶɦɛ ֆȶʀɨƈȶɛֆȶ ֆɛռֆɛ, "ʟɛǟӄɨռɢ" ɨֆ ֆօ ǟɮֆȶʀǟƈȶ ǟֆ
ȶօ ɮɛ ʊռքʀɛʋɛռȶǟɮʟɛ. Ɨȶ'ֆ զʊɨȶɛ ȶʀɨʋɨǟʟ ȶօ ɨռɨȶɨǟʟɨʐɛ ǟ ƈօʟʟɛƈȶɨօռ ǟȶ ȶɦɛ ֆȶǟʀȶ
օʄ ǟ քʀօɢʀǟʍ, ʄɨʟʟ ɨȶ աɨȶɦ ȶօռֆ օʄ օɮʝɛƈȶֆ աɨȶɦ ɖɛֆȶʀʊƈȶօʀֆ, ǟռɖ ȶɦɛռ ɛռȶɛʀ ǟռ
ɨռʄɨռɨȶɛ ɛʋɛռȶ ʟօօք ȶɦǟȶ ռɛʋɛʀ ʀɛʄɛʀֆ ȶօ ɨȶ. Ƭɦɛ ƈօʟʟɛƈȶɨօռ աɨʟʟ ֆɨȶ ǟʀօʊռɖ
ʊֆɛʟɛֆֆʟʏ, ɦօʟɖɨռɢ օռ ȶօ ɨȶֆ քʀɛƈɨօʊֆ ʀɛֆօʊʀƈɛֆ ʊռȶɨʟ ȶɦɛ քʀօɢʀǟʍ ȶɛʀʍɨռǟȶɛֆ (ǟȶ
աɦɨƈɦ քօɨռȶ ǟʟʟ ȶɦօֆɛ ʀɛֆօʊʀƈɛֆ աօʊʟɖ ɦǟʋɛ ɮɛɛռ ʀɛƈʟǟɨʍɛɖ ɮʏ ȶɦɛ ØՖ ǟռʏաǟʏ).

Ɯɛ ʍǟʏ ƈօռֆɨɖɛʀ ǟ ʍօʀɛ ʀɛֆȶʀɨƈȶɛɖ ʄօʀʍ օʄ ʟɛǟӄ: ʄǟɨʟɨռɢ ȶօ ɖʀօք ǟ ʋǟʟʊɛ ȶɦǟȶ ɨֆ
ʊռʀɛǟƈɦǟɮʟɛ. Ʀʊֆȶ ǟʟֆօ ɖօɛֆռ'ȶ քʀɛʋɛռȶ ȶɦɨֆ. Ɨռ ʄǟƈȶ Ʀʊֆȶ *ɦǟֆ ǟ ʄʊռƈȶɨօռ ʄօʀ
ɖօɨռɢ ȶɦɨֆ*: `ʍɛʍ::ʄօʀɢɛȶ`. Ƭɦɨֆ ʄʊռƈȶɨօռ ƈօռֆʊʍɛֆ ȶɦɛ ʋǟʟʊɛ ɨȶ ɨֆ քǟֆֆɛɖ *ǟռɖ
ȶɦɛռ ɖօɛֆռ'ȶ ʀʊռ ɨȶֆ ɖɛֆȶʀʊƈȶօʀ*.

Ɨռ ȶɦɛ քǟֆȶ `ʍɛʍ::ʄօʀɢɛȶ` աǟֆ ʍǟʀӄɛɖ ǟֆ ʊռֆǟʄɛ ǟֆ ǟ ֆօʀȶ օʄ ʟɨռȶ ǟɢǟɨռֆȶ ʊֆɨռɢ
ɨȶ, ֆɨռƈɛ ʄǟɨʟɨռɢ ȶօ ƈǟʟʟ ǟ ɖɛֆȶʀʊƈȶօʀ ɨֆ ɢɛռɛʀǟʟʟʏ ռօȶ ǟ աɛʟʟ-ɮɛɦǟʋɛɖ ȶɦɨռɢ ȶօ
ɖօ (ȶɦօʊɢɦ ʊֆɛʄʊʟ ʄօʀ ֆօʍɛ ֆքɛƈɨǟʟ ʊռֆǟʄɛ ƈօɖɛ). Ӈօաɛʋɛʀ ȶɦɨֆ աǟֆ ɢɛռɛʀǟʟʟʏ
ɖɛȶɛʀʍɨռɛɖ ȶօ ɮɛ ǟռ ʊռȶɛռǟɮʟɛ ֆȶǟռƈɛ ȶօ ȶǟӄɛ: ȶɦɛʀɛ ǟʀɛ ʍǟռʏ աǟʏֆ ȶօ ʄǟɨʟ ȶօ
ƈǟʟʟ ǟ ɖɛֆȶʀʊƈȶօʀ ɨռ ֆǟʄɛ ƈօɖɛ. Ƭɦɛ ʍօֆȶ ʄǟʍօʊֆ ɛӼǟʍքʟɛ ɨֆ ƈʀɛǟȶɨռɢ ǟ ƈʏƈʟɛ օʄ
ʀɛʄɛʀɛռƈɛ-ƈօʊռȶɛɖ քօɨռȶɛʀֆ ʊֆɨռɢ ɨռȶɛʀɨօʀ ʍʊȶǟɮɨʟɨȶʏ.

Ɨȶ ɨֆ ʀɛǟֆօռǟɮʟɛ ʄօʀ ֆǟʄɛ ƈօɖɛ ȶօ ǟֆֆʊʍɛ ȶɦǟȶ ɖɛֆȶʀʊƈȶօʀ ʟɛǟӄֆ ɖօ ռօȶ ɦǟքքɛռ, ǟֆ
ǟռʏ քʀօɢʀǟʍ ȶɦǟȶ ʟɛǟӄֆ ɖɛֆȶʀʊƈȶօʀֆ ɨֆ քʀօɮǟɮʟʏ աʀօռɢ. Ӈօաɛʋɛʀ *ʊռֆǟʄɛ* ƈօɖɛ
ƈǟռռօȶ ʀɛʟʏ օռ ɖɛֆȶʀʊƈȶօʀֆ ȶօ ɮɛ ʀʊռ ɨռ օʀɖɛʀ ȶօ ɮɛ ֆǟʄɛ. Ƒօʀ ʍօֆȶ ȶʏքɛֆ ȶɦɨֆ
ɖօɛֆռ'ȶ ʍǟȶȶɛʀ: ɨʄ ʏօʊ ʟɛǟӄ ȶɦɛ ɖɛֆȶʀʊƈȶօʀ ȶɦɛռ ȶɦɛ ȶʏքɛ ɨֆ ɮʏ ɖɛʄɨռɨȶɨօռ
ɨռǟƈƈɛֆֆɨɮʟɛ, ֆօ ɨȶ ɖօɛֆռ'ȶ ʍǟȶȶɛʀ, ʀɨɢɦȶ? Ƒօʀ ɨռֆȶǟռƈɛ, ɨʄ ʏօʊ ʟɛǟӄ ǟ `ƁօӼ<ʊ8>`
ȶɦɛռ ʏօʊ աǟֆȶɛ ֆօʍɛ ʍɛʍօʀʏ ɮʊȶ ȶɦǟȶ'ֆ ɦǟʀɖʟʏ ɢօɨռɢ ȶօ ʋɨօʟǟȶɛ ʍɛʍօʀʏ-ֆǟʄɛȶʏ.

Ӈօաɛʋɛʀ աɦɛʀɛ աɛ ʍʊֆȶ ɮɛ ƈǟʀɛʄʊʟ աɨȶɦ ɖɛֆȶʀʊƈȶօʀ ʟɛǟӄֆ ǟʀɛ *քʀօӼʏ* ȶʏքɛֆ. Ƭɦɛֆɛ
ǟʀɛ ȶʏքɛֆ աɦɨƈɦ ʍǟռǟɢɛ ǟƈƈɛֆֆ ȶօ ǟ ɖɨֆȶɨռƈȶ օɮʝɛƈȶ, ɮʊȶ ɖօռ'ȶ ǟƈȶʊǟʟʟʏ օառ ɨȶ.
ՔʀօӼʏ օɮʝɛƈȶֆ ǟʀɛ զʊɨȶɛ ʀǟʀɛ. ՔʀօӼʏ օɮʝɛƈȶֆ ʏօʊ'ʟʟ ռɛɛɖ ȶօ ƈǟʀɛ ǟɮօʊȶ ǟʀɛ ɛʋɛռ
ʀǟʀɛʀ. Ӈօաɛʋɛʀ աɛ'ʟʟ ʄօƈʊֆ օռ ȶɦʀɛɛ ɨռȶɛʀɛֆȶɨռɢ ɛӼǟʍքʟɛֆ ɨռ ȶɦɛ ֆȶǟռɖǟʀɖ
ʟɨɮʀǟʀʏ:

* `ʋɛƈ::Ɖʀǟɨռ`
* `Ʀƈ`
* `ȶɦʀɛǟɖ::ֆƈօքɛɖ::ɈօɨռƓʊǟʀɖ`

## Ɖʀǟɨռ

`ɖʀǟɨռ` ɨֆ ǟ ƈօʟʟɛƈȶɨօռֆ ǞՔƗ ȶɦǟȶ ʍօʋɛֆ ɖǟȶǟ օʊȶ օʄ ȶɦɛ ƈօռȶǟɨռɛʀ աɨȶɦօʊȶ
ƈօռֆʊʍɨռɢ ȶɦɛ ƈօռȶǟɨռɛʀ. Ƭɦɨֆ ɛռǟɮʟɛֆ ʊֆ ȶօ ʀɛʊֆɛ ȶɦɛ ǟʟʟօƈǟȶɨօռ օʄ ǟ `Ʋɛƈ`
ǟʄȶɛʀ ƈʟǟɨʍɨռɢ օառɛʀֆɦɨք օʋɛʀ ǟʟʟ օʄ ɨȶֆ ƈօռȶɛռȶֆ. Ɨȶ քʀօɖʊƈɛֆ ǟռ ɨȶɛʀǟȶօʀ
(Ɖʀǟɨռ) ȶɦǟȶ ʀɛȶʊʀռֆ ȶɦɛ ƈօռȶɛռȶֆ օʄ ȶɦɛ Ʋɛƈ ɮʏ-ʋǟʟʊɛ.

Ռօա, ƈօռֆɨɖɛʀ Ɖʀǟɨռ ɨռ ȶɦɛ ʍɨɖɖʟɛ օʄ ɨȶɛʀǟȶɨօռ: ֆօʍɛ ʋǟʟʊɛֆ ɦǟʋɛ ɮɛɛռ ʍօʋɛɖ օʊȶ,
ǟռɖ օȶɦɛʀֆ ɦǟʋɛռ'ȶ. Ƭɦɨֆ ʍɛǟռֆ ȶɦǟȶ քǟʀȶ օʄ ȶɦɛ Ʋɛƈ ɨֆ ռօա ʄʊʟʟ օʄ ʟօɢɨƈǟʟʟʏ
ʊռɨռɨȶɨǟʟɨʐɛɖ ɖǟȶǟ! Ɯɛ ƈօʊʟɖ ɮǟƈӄֆɦɨʄȶ ǟʟʟ ȶɦɛ ɛʟɛʍɛռȶֆ ɨռ ȶɦɛ Ʋɛƈ ɛʋɛʀʏ ȶɨʍɛ աɛ
ʀɛʍօʋɛ ǟ ʋǟʟʊɛ, ɮʊȶ ȶɦɨֆ աօʊʟɖ ɦǟʋɛ քʀɛȶȶʏ ƈǟȶǟֆȶʀօքɦɨƈ քɛʀʄօʀʍǟռƈɛ
ƈօռֆɛզʊɛռƈɛֆ.

Ɨռֆȶɛǟɖ, աɛ աօʊʟɖ ʟɨӄɛ Ɖʀǟɨռ ȶօ ʄɨӼ ȶɦɛ Ʋɛƈ'ֆ ɮǟƈӄɨռɢ ֆȶօʀǟɢɛ աɦɛռ ɨȶ ɨֆ
ɖʀօքքɛɖ. Ɨȶ ֆɦօʊʟɖ ʀʊռ ɨȶֆɛʟʄ ȶօ ƈօʍքʟɛȶɨօռ, ɮǟƈӄֆɦɨʄȶ ǟռʏ ɛʟɛʍɛռȶֆ ȶɦǟȶ աɛʀɛռ'ȶ
ʀɛʍօʋɛɖ (ɖʀǟɨռ ֆʊքքօʀȶֆ ֆʊɮʀǟռɢɛֆ), ǟռɖ ȶɦɛռ ʄɨӼ Ʋɛƈ'ֆ `ʟɛռ`. Ɨȶ'ֆ ɛʋɛռ
ʊռաɨռɖɨռɢ-ֆǟʄɛ! Ɛǟֆʏ!

Ռօա ƈօռֆɨɖɛʀ ȶɦɛ ʄօʟʟօաɨռɢ:

<!-- ignore: simplified code -->
```rust,ignore
let mut vec = vec![Box::new(0); 4];

{
    // start draining, vec can no longer be accessed
    let mut drainer = vec.drain(..);

    // pull out two elements and immediately drop them
    drainer.next();
    drainer.next();

    // get rid of drainer, but don't call its destructor
    mem::forget(drainer);
}

// Oops, vec[0] was dropped, we're reading a pointer into free'd memory!
println!("{}", vec[0]);
```

Ƭɦɨֆ ɨֆ քʀɛȶȶʏ ƈʟɛǟʀʟʏ Ռօȶ Ɠօօɖ. Ʊռʄօʀȶʊռǟȶɛʟʏ, աɛ'ʀɛ ӄɨռɖ օʄ ֆȶʊƈӄ ɮɛȶաɛɛռ ǟ
ʀօƈӄ ǟռɖ ǟ ɦǟʀɖ քʟǟƈɛ: ʍǟɨռȶǟɨռɨռɢ ƈօռֆɨֆȶɛռȶ ֆȶǟȶɛ ǟȶ ɛʋɛʀʏ ֆȶɛք ɦǟֆ ǟռ
ɛռօʀʍօʊֆ ƈօֆȶ (ǟռɖ աօʊʟɖ ռɛɢǟȶɛ ǟռʏ ɮɛռɛʄɨȶֆ օʄ ȶɦɛ ǞՔƗ). Ƒǟɨʟɨռɢ ȶօ ʍǟɨռȶǟɨռ
ƈօռֆɨֆȶɛռȶ ֆȶǟȶɛ ɢɨʋɛֆ ʊֆ Ʊռɖɛʄɨռɛɖ Ɓɛɦǟʋɨօʀ ɨռ ֆǟʄɛ ƈօɖɛ (ʍǟӄɨռɢ ȶɦɛ ǞՔƗ
ʊռֆօʊռɖ).

Ֆօ աɦǟȶ ƈǟռ աɛ ɖօ? Ɯɛʟʟ, աɛ ƈǟռ քɨƈӄ ǟ ȶʀɨʋɨǟʟʟʏ ƈօռֆɨֆȶɛռȶ ֆȶǟȶɛ: ֆɛȶ ȶɦɛ Ʋɛƈ'ֆ
ʟɛռ ȶօ ɮɛ 0 աɦɛռ աɛ ֆȶǟʀȶ ȶɦɛ ɨȶɛʀǟȶɨօռ, ǟռɖ ʄɨӼ ɨȶ ʊք ɨʄ ռɛƈɛֆֆǟʀʏ ɨռ ȶɦɛ
ɖɛֆȶʀʊƈȶօʀ. Ƭɦǟȶ աǟʏ, ɨʄ ɛʋɛʀʏȶɦɨռɢ ɛӼɛƈʊȶɛֆ ʟɨӄɛ ռօʀʍǟʟ աɛ ɢɛȶ ȶɦɛ ɖɛֆɨʀɛɖ
ɮɛɦǟʋɨօʀ աɨȶɦ ʍɨռɨʍǟʟ օʋɛʀɦɛǟɖ. Ɓʊȶ ɨʄ ֆօʍɛօռɛ ɦǟֆ ȶɦɛ *ǟʊɖǟƈɨȶʏ* ȶօ
ʍɛʍ::ʄօʀɢɛȶ ʊֆ ɨռ ȶɦɛ ʍɨɖɖʟɛ օʄ ȶɦɛ ɨȶɛʀǟȶɨօռ, ǟʟʟ ȶɦǟȶ ɖօɛֆ ɨֆ *ʟɛǟӄ ɛʋɛռ ʍօʀɛ*
(ǟռɖ քօֆֆɨɮʟʏ ʟɛǟʋɛ ȶɦɛ Ʋɛƈ ɨռ ǟռ ʊռɛӼքɛƈȶɛɖ ɮʊȶ օȶɦɛʀաɨֆɛ ƈօռֆɨֆȶɛռȶ ֆȶǟȶɛ).
Ֆɨռƈɛ աɛ'ʋɛ ǟƈƈɛքȶɛɖ ȶɦǟȶ ʍɛʍ::ʄօʀɢɛȶ ɨֆ ֆǟʄɛ, ȶɦɨֆ ɨֆ ɖɛʄɨռɨȶɛʟʏ ֆǟʄɛ. Ɯɛ ƈǟʟʟ
ʟɛǟӄֆ ƈǟʊֆɨռɢ ʍօʀɛ ʟɛǟӄֆ ǟ *ʟɛǟӄ ǟʍքʟɨʄɨƈǟȶɨօռ*.

## Ʀƈ

Ʀƈ ɨֆ ǟռ ɨռȶɛʀɛֆȶɨռɢ ƈǟֆɛ ɮɛƈǟʊֆɛ ǟȶ ʄɨʀֆȶ ɢʟǟռƈɛ ɨȶ ɖօɛֆռ'ȶ ǟքքɛǟʀ ȶօ ɮɛ ǟ
քʀօӼʏ ʋǟʟʊɛ ǟȶ ǟʟʟ. Ǟʄȶɛʀ ǟʟʟ, ɨȶ ʍǟռǟɢɛֆ ȶɦɛ ɖǟȶǟ ɨȶ քօɨռȶֆ ȶօ, ǟռɖ ɖʀօքքɨռɢ
ǟʟʟ ȶɦɛ Ʀƈֆ ʄօʀ ǟ ʋǟʟʊɛ աɨʟʟ ɖʀօք ȶɦǟȶ ʋǟʟʊɛ. Łɛǟӄɨռɢ ǟռ Ʀƈ ɖօɛֆռ'ȶ ֆɛɛʍ ʟɨӄɛ ɨȶ
աօʊʟɖ ɮɛ քǟʀȶɨƈʊʟǟʀʟʏ ɖǟռɢɛʀօʊֆ. Ɨȶ աɨʟʟ ʟɛǟʋɛ ȶɦɛ ʀɛʄƈօʊռȶ քɛʀʍǟռɛռȶʟʏ
ɨռƈʀɛʍɛռȶɛɖ ǟռɖ քʀɛʋɛռȶ ȶɦɛ ɖǟȶǟ ʄʀօʍ ɮɛɨռɢ ʄʀɛɛɖ օʀ ɖʀօքքɛɖ, ɮʊȶ ȶɦǟȶ ֆɛɛʍֆ
ʝʊֆȶ ʟɨӄɛ ƁօӼ, ʀɨɢɦȶ?

Ռօքɛ.

Łɛȶ'ֆ ƈօռֆɨɖɛʀ ǟ ֆɨʍքʟɨʄɨɛɖ ɨʍքʟɛʍɛռȶǟȶɨօռ օʄ Ʀƈ:

<!-- ignore: simplified code -->
```rust,ignore
struct Rc<T> {
    ptr: *mut RcBox<T>,
}

struct RcBox<T> {
    data: T,
    ref_count: usize,
}

impl<T> Rc<T> {
    fn new(data: T) -> Self {
        unsafe {
            // Wouldn't it be nice if heap::allocate worked like this?
            let ptr = heap::allocate::<RcBox<T>>();
            ptr::write(ptr, RcBox {
                data,
                ref_count: 1,
            });
            Rc { ptr }
        }
    }

    fn clone(&self) -> Self {
        unsafe {
            (*self.ptr).ref_count += 1;
        }
        Rc { ptr: self.ptr }
    }
}

impl<T> Drop for Rc<T> {
    fn drop(&mut self) {
        unsafe {
            (*self.ptr).ref_count -= 1;
            if (*self.ptr).ref_count == 0 {
                // drop the data and then free it
                ptr::read(self.ptr);
                heap::deallocate(self.ptr);
            }
        }
    }
}
```

Ƭɦɨֆ ƈօɖɛ ƈօռȶǟɨռֆ ǟռ ɨʍքʟɨƈɨȶ ǟռɖ ֆʊɮȶʟɛ ǟֆֆʊʍքȶɨօռ: `ʀɛʄ_ƈօʊռȶ` ƈǟռ ʄɨȶ ɨռ ǟ
`ʊֆɨʐɛ`, ɮɛƈǟʊֆɛ ȶɦɛʀɛ ƈǟռ'ȶ ɮɛ ʍօʀɛ ȶɦǟռ `ʊֆɨʐɛ::ⱮǞҲ` Ʀƈֆ ɨռ ʍɛʍօʀʏ. Ӈօաɛʋɛʀ
ȶɦɨֆ ɨȶֆɛʟʄ ǟֆֆʊʍɛֆ ȶɦǟȶ ȶɦɛ `ʀɛʄ_ƈօʊռȶ` ǟƈƈʊʀǟȶɛʟʏ ʀɛʄʟɛƈȶֆ ȶɦɛ ռʊʍɮɛʀ օʄ Ʀƈֆ
ɨռ ʍɛʍօʀʏ, աɦɨƈɦ աɛ ӄռօա ɨֆ ʄǟʟֆɛ աɨȶɦ `ʍɛʍ::ʄօʀɢɛȶ`. Ʊֆɨռɢ `ʍɛʍ::ʄօʀɢɛȶ` աɛ ƈǟռ
օʋɛʀʄʟօա ȶɦɛ `ʀɛʄ_ƈօʊռȶ`, ǟռɖ ȶɦɛռ ɢɛȶ ɨȶ ɖօառ ȶօ 0 աɨȶɦ օʊȶֆȶǟռɖɨռɢ Ʀƈֆ. Ƭɦɛռ
աɛ ƈǟռ ɦǟքքɨʟʏ ʊֆɛ-ǟʄȶɛʀ-ʄʀɛɛ ȶɦɛ ɨռռɛʀ ɖǟȶǟ. Ɓǟɖ Ɓǟɖ Ռօȶ Ɠօօɖ.

Ƭɦɨֆ ƈǟռ ɮɛ ֆօʟʋɛɖ ɮʏ ʝʊֆȶ ƈɦɛƈӄɨռɢ ȶɦɛ `ʀɛʄ_ƈօʊռȶ` ǟռɖ ɖօɨռɢ *ֆօʍɛȶɦɨռɢ*. Ƭɦɛ
ֆȶǟռɖǟʀɖ ʟɨɮʀǟʀʏ'ֆ ֆȶǟռƈɛ ɨֆ ȶօ ʝʊֆȶ ǟɮօʀȶ, ɮɛƈǟʊֆɛ ʏօʊʀ քʀօɢʀǟʍ ɦǟֆ ɮɛƈօʍɛ
ɦօʀʀɨɮʟʏ ɖɛɢɛռɛʀǟȶɛ. Ǟʟֆօ *օɦ ʍʏ ɢօֆɦ* ɨȶ'ֆ ֆʊƈɦ ǟ ʀɨɖɨƈʊʟօʊֆ ƈօʀռɛʀ ƈǟֆɛ.

## ȶɦʀɛǟɖ::ֆƈօքɛɖ::ɈօɨռƓʊǟʀɖ

> Ռօȶɛ: Ƭɦɨֆ ǞՔƗ ɦǟֆ ǟʟʀɛǟɖʏ ɮɛɛռ ʀɛʍօʋɛɖ ʄʀօʍ ֆȶɖ, ʄօʀ ʍօʀɛ ɨռʄօʀʍǟȶɨօռ
> ʏօʊ ʍǟʏ ʀɛʄɛʀ [ɨֆֆʊɛ #24292](https://github.com/rust-lang/rust/issues/24292).
>
> Ƭɦɨֆ ֆɛƈȶɨօռ ʀɛʍǟɨռֆ ɦɛʀɛ ɮɛƈǟʊֆɛ աɛ ȶɦɨռӄ ȶɦɨֆ ɛӼǟʍքʟɛ ɨֆ ֆȶɨʟʟ
> ɨʍքօʀȶǟռȶ, ʀɛɢǟʀɖʟɛֆֆ օʄ աɦɛȶɦɛʀ ɨȶ ɨֆ քǟʀȶ օʄ ֆȶɖ օʀ ռօȶ.

Ƭɦɛ ȶɦʀɛǟɖ::ֆƈօքɛɖ ǞՔƗ ɨռȶɛռɖɛɖ ȶօ ǟʟʟօա ȶɦʀɛǟɖֆ ȶօ ɮɛ ֆքǟառɛɖ ȶɦǟȶ ʀɛʄɛʀɛռƈɛ
ɖǟȶǟ օռ ȶɦɛɨʀ քǟʀɛռȶ'ֆ ֆȶǟƈӄ աɨȶɦօʊȶ ǟռʏ ֆʏռƈɦʀօռɨʐǟȶɨօռ օʋɛʀ ȶɦǟȶ ɖǟȶǟ ɮʏ
ɛռֆʊʀɨռɢ ȶɦɛ քǟʀɛռȶ ʝօɨռֆ ȶɦɛ ȶɦʀɛǟɖ ɮɛʄօʀɛ ǟռʏ օʄ ȶɦɛ ֆɦǟʀɛɖ ɖǟȶǟ ɢօɛֆ օʊȶ
օʄ ֆƈօքɛ.

<!-- ignore: simplified code -->
```rust,ignore
pub fn scoped<'a, F>(f: F) -> JoinGuard<'a>
    where F: FnOnce() + Send + 'a
```

Ӈɛʀɛ `ʄ` ɨֆ ֆօʍɛ ƈʟօֆʊʀɛ ʄօʀ ȶɦɛ օȶɦɛʀ ȶɦʀɛǟɖ ȶօ ɛӼɛƈʊȶɛ. Ֆǟʏɨռɢ ȶɦǟȶ
`Ƒ: Ֆɛռɖ + 'ǟ` ɨֆ ֆǟʏɨռɢ ȶɦǟȶ ɨȶ ƈʟօֆɛֆ օʋɛʀ ɖǟȶǟ ȶɦǟȶ ʟɨʋɛֆ ʄօʀ `'ǟ`, ǟռɖ ɨȶ
ɛɨȶɦɛʀ օառֆ ȶɦǟȶ ɖǟȶǟ օʀ ȶɦɛ ɖǟȶǟ աǟֆ Ֆʏռƈ (ɨʍքʟʏɨռɢ `&ɖǟȶǟ` ɨֆ Ֆɛռɖ).

Ɓɛƈǟʊֆɛ ɈօɨռƓʊǟʀɖ ɦǟֆ ǟ ʟɨʄɛȶɨʍɛ, ɨȶ ӄɛɛքֆ ǟʟʟ ȶɦɛ ɖǟȶǟ ɨȶ ƈʟօֆɛֆ օʋɛʀ
ɮօʀʀօաɛɖ ɨռ ȶɦɛ քǟʀɛռȶ ȶɦʀɛǟɖ. Ƭɦɨֆ ʍɛǟռֆ ȶɦɛ ɈօɨռƓʊǟʀɖ ƈǟռ'ȶ օʊȶʟɨʋɛ
ȶɦɛ ɖǟȶǟ ȶɦǟȶ ȶɦɛ օȶɦɛʀ ȶɦʀɛǟɖ ɨֆ աօʀӄɨռɢ օռ. Ɯɦɛռ ȶɦɛ ɈօɨռƓʊǟʀɖ *ɖօɛֆ* ɢɛȶ
ɖʀօքքɛɖ ɨȶ ɮʟօƈӄֆ ȶɦɛ քǟʀɛռȶ ȶɦʀɛǟɖ, ɛռֆʊʀɨռɢ ȶɦɛ ƈɦɨʟɖ ȶɛʀʍɨռǟȶɛֆ ɮɛʄօʀɛ ǟռʏ
օʄ ȶɦɛ ƈʟօֆɛɖ-օʋɛʀ ɖǟȶǟ ɢօɛֆ օʊȶ օʄ ֆƈօքɛ ɨռ ȶɦɛ քǟʀɛռȶ.

Ʊֆǟɢɛ ʟօօӄɛɖ ʟɨӄɛ:

<!-- ignore: simplified code -->
```rust,ignore
let mut data = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
{
    let mut guards = vec![];
    for x in &mut data {
        // Move the mutable reference into the closure, and execute
        // it on a different thread. The closure has a lifetime bound
        // by the lifetime of the mutable reference `x` we store in it.
        // The guard that is returned is in turn assigned the lifetime
        // of the closure, so it also mutably borrows `data` as `x` did.
        // This means we cannot access `data` until the guard goes away.
        let guard = thread::scoped(move || {
            *x *= 2;
        });
        // store the thread's guard for later
        guards.push(guard);
    }
    // All guards are dropped here, forcing the threads to join
    // (this thread blocks here until the others terminate).
    // Once the threads join, the borrow expires and the data becomes
    // accessible again in this thread.
}
// data is definitely mutated here.
```

Ɨռ քʀɨռƈɨքʟɛ, ȶɦɨֆ ȶօȶǟʟʟʏ աօʀӄֆ! Ʀʊֆȶ'ֆ օառɛʀֆɦɨք ֆʏֆȶɛʍ քɛʀʄɛƈȶʟʏ ɛռֆʊʀɛֆ ɨȶ!
...ɛӼƈɛքȶ ɨȶ ʀɛʟɨɛֆ օռ ǟ ɖɛֆȶʀʊƈȶօʀ ɮɛɨռɢ ƈǟʟʟɛɖ ȶօ ɮɛ ֆǟʄɛ.

<!-- ignore: simplified code -->
```rust,ignore
let mut data = Box::new(0);
{
    let guard = thread::scoped(|| {
        // This is at best a data race. At worst, it's also a use-after-free.
        *data += 1;
    });
    // Because the guard is forgotten, expiring the loan without blocking this
    // thread.
    mem::forget(guard);
}
// So the Box is dropped here while the scoped thread may or may not be trying
// to access it.
```

Ɖǟռɢ. Ӈɛʀɛ ȶɦɛ ɖɛֆȶʀʊƈȶօʀ ʀʊռռɨռɢ աǟֆ քʀɛȶȶʏ ʄʊռɖǟʍɛռȶǟʟ ȶօ ȶɦɛ ǞՔƗ, ǟռɖ ɨȶ ɦǟɖ
ȶօ ɮɛ ֆƈʀǟքքɛɖ ɨռ ʄǟʋօʀ օʄ ǟ ƈօʍքʟɛȶɛʟʏ ɖɨʄʄɛʀɛռȶ ɖɛֆɨɢռ.
