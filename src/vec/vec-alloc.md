# Ǟʟʟօƈǟȶɨռɢ Ɱɛʍօʀʏ

Ʊֆɨռɢ `ՌօռՌʊʟʟ` ȶɦʀօաֆ ǟ աʀɛռƈɦ ɨռ ǟռ ɨʍքօʀȶǟռȶ ʄɛǟȶʊʀɛ օʄ Ʋɛƈ (ǟռɖ ɨռɖɛɛɖ ǟʟʟ օʄ
ȶɦɛ ֆȶɖ ƈօʟʟɛƈȶɨօռֆ): ƈʀɛǟȶɨռɢ ǟռ ɛʍքȶʏ Ʋɛƈ ɖօɛֆռ'ȶ ǟƈȶʊǟʟʟʏ ǟʟʟօƈǟȶɛ ǟȶ ǟʟʟ. Ƭɦɨֆ
ɨֆ ռօȶ ȶɦɛ ֆǟʍɛ ǟֆ ǟʟʟօƈǟȶɨռɢ ǟ ʐɛʀօ-ֆɨʐɛɖ ʍɛʍօʀʏ ɮʟօƈӄ, աɦɨƈɦ ɨֆ ռօȶ ǟʟʟօաɛɖ ɮʏ
ȶɦɛ ɢʟօɮǟʟ ǟʟʟօƈǟȶօʀ (ɨȶ ʀɛֆʊʟȶֆ ɨռ ʊռɖɛʄɨռɛɖ ɮɛɦǟʋɨօʀ!). Ֆօ ɨʄ աɛ ƈǟռ'ȶ ǟʟʟօƈǟȶɛ,
ɮʊȶ ǟʟֆօ ƈǟռ'ȶ քʊȶ ǟ ռʊʟʟ քօɨռȶɛʀ ɨռ `քȶʀ`, աɦǟȶ ɖօ աɛ ɖօ ɨռ `Ʋɛƈ::ռɛա`? Ɯɛʟʟ, աɛ
ʝʊֆȶ քʊȶ ֆօʍɛ օȶɦɛʀ ɢǟʀɮǟɢɛ ɨռ ȶɦɛʀɛ!

Ƭɦɨֆ ɨֆ քɛʀʄɛƈȶʟʏ ʄɨռɛ ɮɛƈǟʊֆɛ աɛ ǟʟʀɛǟɖʏ ɦǟʋɛ `ƈǟք == 0` ǟֆ օʊʀ ֆɛռȶɨռɛʟ ʄօʀ ռօ
ǟʟʟօƈǟȶɨօռ. Ɯɛ ɖօռ'ȶ ɛʋɛռ ռɛɛɖ ȶօ ɦǟռɖʟɛ ɨȶ ֆքɛƈɨǟʟʟʏ ɨռ ǟʟʍօֆȶ ǟռʏ ƈօɖɛ ɮɛƈǟʊֆɛ
աɛ ʊֆʊǟʟʟʏ ռɛɛɖ ȶօ ƈɦɛƈӄ ɨʄ `ƈǟք > ʟɛռ` օʀ `ʟɛռ > 0` ǟռʏաǟʏ. Ƭɦɛ ʀɛƈօʍʍɛռɖɛɖ
Ʀʊֆȶ ʋǟʟʊɛ ȶօ քʊȶ ɦɛʀɛ ɨֆ `ʍɛʍ::ǟʟɨɢռ_օʄ::<Ƭ>()`. `ՌօռՌʊʟʟ` քʀօʋɨɖɛֆ ǟ ƈօռʋɛռɨɛռƈɛ
ʄօʀ ȶɦɨֆ: `ՌօռՌʊʟʟ::ɖǟռɢʟɨռɢ()`. Ƭɦɛʀɛ ǟʀɛ զʊɨȶɛ ǟ ʄɛա քʟǟƈɛֆ աɦɛʀɛ աɛ'ʟʟ
աǟռȶ ȶօ ʊֆɛ `ɖǟռɢʟɨռɢ` ɮɛƈǟʊֆɛ ȶɦɛʀɛ'ֆ ռօ ʀɛǟʟ ǟʟʟօƈǟȶɨօռ ȶօ ȶǟʟӄ ǟɮօʊȶ ɮʊȶ
`ռʊʟʟ` աօʊʟɖ ʍǟӄɛ ȶɦɛ ƈօʍքɨʟɛʀ ɖօ ɮǟɖ ȶɦɨռɢֆ.

Ֆօ:

<!-- ignore: explanation code -->
```rust,ignore
use std::mem;

impl<T> Vec<T> {
    pub fn new() -> Self {
        assert!(mem::size_of::<T>() != 0, "We're not ready to handle ZSTs");
        Vec {
            ptr: NonNull::dangling(),
            len: 0,
            cap: 0,
        }
    }
}
# fn main() {}
```

Ɨ ֆʟɨքքɛɖ ɨռ ȶɦǟȶ ǟֆֆɛʀȶ ȶɦɛʀɛ ɮɛƈǟʊֆɛ ʐɛʀօ-ֆɨʐɛɖ ȶʏքɛֆ աɨʟʟ ʀɛզʊɨʀɛ ֆօʍɛ
ֆքɛƈɨǟʟ ɦǟռɖʟɨռɢ ȶɦʀօʊɢɦօʊȶ օʊʀ ƈօɖɛ, ǟռɖ Ɨ աǟռȶ ȶօ ɖɛʄɛʀ ȶɦɛ ɨֆֆʊɛ ʄօʀ ռօա.
Ɯɨȶɦօʊȶ ȶɦɨֆ ǟֆֆɛʀȶ, ֆօʍɛ օʄ օʊʀ ɛǟʀʟʏ ɖʀǟʄȶֆ աɨʟʟ ɖօ ֆօʍɛ Ʋɛʀʏ Ɓǟɖ Ƭɦɨռɢֆ.

ՌɛӼȶ աɛ ռɛɛɖ ȶօ ʄɨɢʊʀɛ օʊȶ աɦǟȶ ȶօ ǟƈȶʊǟʟʟʏ ɖօ աɦɛռ աɛ *ɖօ* աǟռȶ ֆքǟƈɛ. Ƒօʀ ȶɦǟȶ,
աɛ ʊֆɛ ȶɦɛ ɢʟօɮǟʟ ǟʟʟօƈǟȶɨօռ ʄʊռƈȶɨօռֆ [`ǟʟʟօƈ`][ǟʟʟօƈ], [`ʀɛǟʟʟօƈ`][ʀɛǟʟʟօƈ],
ǟռɖ [`ɖɛǟʟʟօƈ`][ɖɛǟʟʟօƈ] աɦɨƈɦ ǟʀɛ ǟʋǟɨʟǟɮʟɛ ɨռ ֆȶǟɮʟɛ Ʀʊֆȶ ɨռ
[`ֆȶɖ::ǟʟʟօƈ`][ֆȶɖ_ǟʟʟօƈ]. Ƭɦɛֆɛ ʄʊռƈȶɨօռֆ ǟʀɛ ɛӼքɛƈȶɛɖ ȶօ ɮɛƈօʍɛ ɖɛքʀɛƈǟȶɛɖ ɨռ
ʄǟʋօʀ օʄ ȶɦɛ ʍɛȶɦօɖֆ օʄ [`ֆȶɖ::ǟʟʟօƈ::Ɠʟօɮǟʟ`][Ɠʟօɮǟʟ] ǟʄȶɛʀ ȶɦɨֆ ȶʏքɛ ɨֆ ֆȶǟɮɨʟɨʐɛɖ.

Ɯɛ'ʟʟ ǟʟֆօ ռɛɛɖ ǟ աǟʏ ȶօ ɦǟռɖʟɛ օʊȶ-օʄ-ʍɛʍօʀʏ (ØØⱮ) ƈօռɖɨȶɨօռֆ. Ƭɦɛ ֆȶǟռɖǟʀɖ
ʟɨɮʀǟʀʏ քʀօʋɨɖɛֆ ǟ ʄʊռƈȶɨօռ [`ǟʟʟօƈ::ɦǟռɖʟɛ_ǟʟʟօƈ_ɛʀʀօʀ`][ɦǟռɖʟɛ_ǟʟʟօƈ_ɛʀʀօʀ],
աɦɨƈɦ աɨʟʟ ǟɮօʀȶ ȶɦɛ քʀօɢʀǟʍ ɨռ ǟ քʟǟȶʄօʀʍ-ֆքɛƈɨʄɨƈ ʍǟռռɛʀ.
Ƭɦɛ ʀɛǟֆօռ աɛ ǟɮօʀȶ ǟռɖ ɖօռ'ȶ քǟռɨƈ ɨֆ ɮɛƈǟʊֆɛ ʊռաɨռɖɨռɢ ƈǟռ ƈǟʊֆɛ ǟʟʟօƈǟȶɨօռֆ
ȶօ ɦǟքքɛռ, ǟռɖ ȶɦǟȶ ֆɛɛʍֆ ʟɨӄɛ ǟ ɮǟɖ ȶɦɨռɢ ȶօ ɖօ աɦɛռ ʏօʊʀ ǟʟʟօƈǟȶօʀ ʝʊֆȶ ƈǟʍɛ
ɮǟƈӄ աɨȶɦ "ɦɛʏ Ɨ ɖօռ'ȶ ɦǟʋɛ ǟռʏ ʍօʀɛ ʍɛʍօʀʏ".

Øʄ ƈօʊʀֆɛ, ȶɦɨֆ ɨֆ ǟ ɮɨȶ ֆɨʟʟʏ ֆɨռƈɛ ʍօֆȶ քʟǟȶʄօʀʍֆ ɖօռ'ȶ ǟƈȶʊǟʟʟʏ ʀʊռ օʊȶ օʄ
ʍɛʍօʀʏ ɨռ ǟ ƈօռʋɛռȶɨօռǟʟ աǟʏ. Ƴօʊʀ օքɛʀǟȶɨռɢ ֆʏֆȶɛʍ աɨʟʟ քʀօɮǟɮʟʏ ӄɨʟʟ ȶɦɛ
ǟքքʟɨƈǟȶɨօռ ɮʏ ǟռօȶɦɛʀ ʍɛǟռֆ ɨʄ ʏօʊ ʟɛɢɨȶɨʍǟȶɛʟʏ ֆȶǟʀȶ ʊֆɨռɢ ʊք ǟʟʟ ȶɦɛ ʍɛʍօʀʏ.
Ƭɦɛ ʍօֆȶ ʟɨӄɛʟʏ աǟʏ աɛ'ʟʟ ȶʀɨɢɢɛʀ ØØⱮ ɨֆ ɮʏ ʝʊֆȶ ǟֆӄɨռɢ ʄօʀ ʟʊɖɨƈʀօʊֆ զʊǟռȶɨȶɨɛֆ
օʄ ʍɛʍօʀʏ ǟȶ օռƈɛ (ɛ.ɢ. ɦǟʟʄ ȶɦɛ ȶɦɛօʀɛȶɨƈǟʟ ǟɖɖʀɛֆֆ ֆքǟƈɛ). Ǟֆ ֆʊƈɦ ɨȶ'ֆ
*քʀօɮǟɮʟʏ* ʄɨռɛ ȶօ քǟռɨƈ ǟռɖ ռօȶɦɨռɢ ɮǟɖ աɨʟʟ ɦǟքքɛռ. Ֆȶɨʟʟ, աɛ'ʀɛ ȶʀʏɨռɢ ȶօ ɮɛ
ʟɨӄɛ ȶɦɛ ֆȶǟռɖǟʀɖ ʟɨɮʀǟʀʏ ǟֆ ʍʊƈɦ ǟֆ քօֆֆɨɮʟɛ, ֆօ աɛ'ʟʟ ʝʊֆȶ ӄɨʟʟ ȶɦɛ աɦօʟɛ
քʀօɢʀǟʍ.

Øӄǟʏ, ռօա աɛ ƈǟռ աʀɨȶɛ ɢʀօաɨռɢ. Ʀօʊɢɦʟʏ, աɛ աǟռȶ ȶօ ɦǟʋɛ ȶɦɨֆ ʟօɢɨƈ:

```text
if cap == 0:
    allocate()
    cap = 1
else:
    reallocate()
    cap *= 2
```

Ɓʊȶ Ʀʊֆȶ'ֆ օռʟʏ ֆʊքքօʀȶɛɖ ǟʟʟօƈǟȶօʀ ǞՔƗ ɨֆ ֆօ ʟօա ʟɛʋɛʟ ȶɦǟȶ աɛ'ʟʟ ռɛɛɖ ȶօ ɖօ ǟ
ʄǟɨʀ ɮɨȶ օʄ ɛӼȶʀǟ աօʀӄ. Ɯɛ ǟʟֆօ ռɛɛɖ ȶօ ɢʊǟʀɖ ǟɢǟɨռֆȶ ֆօʍɛ ֆքɛƈɨǟʟ
ƈօռɖɨȶɨօռֆ ȶɦǟȶ ƈǟռ օƈƈʊʀ աɨȶɦ ʀɛǟʟʟʏ ʟǟʀɢɛ ǟʟʟօƈǟȶɨօռֆ օʀ ɛʍքȶʏ ǟʟʟօƈǟȶɨօռֆ.

Ɨռ քǟʀȶɨƈʊʟǟʀ, `քȶʀ::օʄʄֆɛȶ` աɨʟʟ ƈǟʊֆɛ ʊֆ ǟ ʟօȶ օʄ ȶʀօʊɮʟɛ, ɮɛƈǟʊֆɛ ɨȶ ɦǟֆ
ȶɦɛ ֆɛʍǟռȶɨƈֆ օʄ ŁŁƲⱮ'ֆ ƓƐՔ ɨռɮօʊռɖֆ ɨռֆȶʀʊƈȶɨօռ. Ɨʄ ʏօʊ'ʀɛ ʄօʀȶʊռǟȶɛ ɛռօʊɢɦ ȶօ
ռօȶ ɦǟʋɛ ɖɛǟʟȶ աɨȶɦ ȶɦɨֆ ɨռֆȶʀʊƈȶɨօռ, ɦɛʀɛ'ֆ ȶɦɛ ɮǟֆɨƈ ֆȶօʀʏ աɨȶɦ ƓƐՔ: ǟʟɨǟֆ
ǟռǟʟʏֆɨֆ, ǟʟɨǟֆ ǟռǟʟʏֆɨֆ, ǟʟɨǟֆ ǟռǟʟʏֆɨֆ. Ɨȶ'ֆ ֆʊքɛʀ ɨʍքօʀȶǟռȶ ȶօ ǟռ օքȶɨʍɨʐɨռɢ
ƈօʍքɨʟɛʀ ȶօ ɮɛ ǟɮʟɛ ȶօ ʀɛǟֆօռ ǟɮօʊȶ ɖǟȶǟ ɖɛքɛռɖɛռƈɨɛֆ ǟռɖ ǟʟɨǟֆɨռɢ.

Ǟֆ ǟ ֆɨʍքʟɛ ɛӼǟʍքʟɛ, ƈօռֆɨɖɛʀ ȶɦɛ ʄօʟʟօաɨռɢ ʄʀǟɢʍɛռȶ օʄ ƈօɖɛ:

<!-- ignore: simplified code -->
```rust,ignore
*x *= 7;
*y *= 3;
```

Ɨʄ ȶɦɛ ƈօʍքɨʟɛʀ ƈǟռ քʀօʋɛ ȶɦǟȶ `Ӽ` ǟռɖ `ʏ` քօɨռȶ ȶօ ɖɨʄʄɛʀɛռȶ ʟօƈǟȶɨօռֆ ɨռ
ʍɛʍօʀʏ, ȶɦɛ ȶաօ օքɛʀǟȶɨօռֆ ƈǟռ ɨռ ȶɦɛօʀʏ ɮɛ ɛӼɛƈʊȶɛɖ ɨռ քǟʀǟʟʟɛʟ (ɮʏ ɛ.ɢ.
ʟօǟɖɨռɢ ȶɦɛʍ ɨռȶօ ɖɨʄʄɛʀɛռȶ ʀɛɢɨֆȶɛʀֆ ǟռɖ աօʀӄɨռɢ օռ ȶɦɛʍ ɨռɖɛքɛռɖɛռȶʟʏ).
Ӈօաɛʋɛʀ ȶɦɛ ƈօʍքɨʟɛʀ ƈǟռ'ȶ ɖօ ȶɦɨֆ ɨռ ɢɛռɛʀǟʟ ɮɛƈǟʊֆɛ ɨʄ Ӽ ǟռɖ ʏ քօɨռȶ ȶօ
ȶɦɛ ֆǟʍɛ ʟօƈǟȶɨօռ ɨռ ʍɛʍօʀʏ, ȶɦɛ օքɛʀǟȶɨօռֆ ռɛɛɖ ȶօ ɮɛ ɖօռɛ ȶօ ȶɦɛ ֆǟʍɛ ʋǟʟʊɛ,
ǟռɖ ȶɦɛʏ ƈǟռ'ȶ ʝʊֆȶ ɮɛ ʍɛʀɢɛɖ ǟʄȶɛʀաǟʀɖֆ.

Ɯɦɛռ ʏօʊ ʊֆɛ ƓƐՔ ɨռɮօʊռɖֆ, ʏօʊ ǟʀɛ ֆքɛƈɨʄɨƈǟʟʟʏ ȶɛʟʟɨռɢ ŁŁƲⱮ ȶɦǟȶ ȶɦɛ օʄʄֆɛȶֆ
ʏօʊ'ʀɛ ǟɮօʊȶ ȶօ ɖօ ǟʀɛ աɨȶɦɨռ ȶɦɛ ɮօʊռɖֆ օʄ ǟ ֆɨռɢʟɛ "ǟʟʟօƈǟȶɛɖ" ɛռȶɨȶʏ. Ƭɦɛ
ʊʟȶɨʍǟȶɛ քǟʏօʄʄ ɮɛɨռɢ ȶɦǟȶ ŁŁƲⱮ ƈǟռ ǟֆֆʊʍɛ ȶɦǟȶ ɨʄ ȶաօ քօɨռȶɛʀֆ ǟʀɛ ӄռօառ ȶօ
քօɨռȶ ȶօ ȶաօ ɖɨֆʝօɨռȶ օɮʝɛƈȶֆ, ǟʟʟ ȶɦɛ օʄʄֆɛȶֆ օʄ ȶɦօֆɛ քօɨռȶɛʀֆ ǟʀɛ *ǟʟֆօ*
ӄռօառ ȶօ ռօȶ ǟʟɨǟֆ (ɮɛƈǟʊֆɛ ʏօʊ աօռ'ȶ ʝʊֆȶ ɛռɖ ʊք ɨռ ֆօʍɛ ʀǟռɖօʍ քʟǟƈɛ ɨռ
ʍɛʍօʀʏ). ŁŁƲⱮ ɨֆ ɦɛǟʋɨʟʏ օքȶɨʍɨʐɛɖ ȶօ աօʀӄ աɨȶɦ ƓƐՔ օʄʄֆɛȶֆ, ǟռɖ ɨռɮօʊռɖֆ
օʄʄֆɛȶֆ ǟʀɛ ȶɦɛ ɮɛֆȶ օʄ ǟʟʟ, ֆօ ɨȶ'ֆ ɨʍքօʀȶǟռȶ ȶɦǟȶ աɛ ʊֆɛ ȶɦɛʍ ǟֆ ʍʊƈɦ ǟֆ
քօֆֆɨɮʟɛ.

Ֆօ ȶɦǟȶ'ֆ աɦǟȶ ƓƐՔ'ֆ ǟɮօʊȶ, ɦօա ƈǟռ ɨȶ ƈǟʊֆɛ ʊֆ ȶʀօʊɮʟɛ?

Ƭɦɛ ʄɨʀֆȶ քʀօɮʟɛʍ ɨֆ ȶɦǟȶ աɛ ɨռɖɛӼ ɨռȶօ ǟʀʀǟʏֆ աɨȶɦ ʊռֆɨɢռɛɖ ɨռȶɛɢɛʀֆ, ɮʊȶ
ƓƐՔ (ǟռɖ ǟֆ ǟ ƈօռֆɛզʊɛռƈɛ `քȶʀ::օʄʄֆɛȶ`) ȶǟӄɛֆ ǟ ֆɨɢռɛɖ ɨռȶɛɢɛʀ. Ƭɦɨֆ ʍɛǟռֆ
ȶɦǟȶ ɦǟʟʄ օʄ ȶɦɛ ֆɛɛʍɨռɢʟʏ ʋǟʟɨɖ ɨռɖɨƈɛֆ ɨռȶօ ǟռ ǟʀʀǟʏ աɨʟʟ օʋɛʀʄʟօա ƓƐՔ ǟռɖ
ǟƈȶʊǟʟʟʏ ɢօ ɨռ ȶɦɛ աʀօռɢ ɖɨʀɛƈȶɨօռ! Ǟֆ ֆʊƈɦ աɛ ʍʊֆȶ ʟɨʍɨȶ ǟʟʟ ǟʟʟօƈǟȶɨօռֆ ȶօ
`ɨֆɨʐɛ::ⱮǞҲ` ɛʟɛʍɛռȶֆ. Ƭɦɨֆ ǟƈȶʊǟʟʟʏ ʍɛǟռֆ աɛ օռʟʏ ռɛɛɖ ȶօ աօʀʀʏ ǟɮօʊȶ
ɮʏȶɛ-ֆɨʐɛɖ օɮʝɛƈȶֆ, ɮɛƈǟʊֆɛ ɛ.ɢ. `> ɨֆɨʐɛ::ⱮǞҲ` `ʊ16`ֆ աɨʟʟ ȶʀʊʟʏ ɛӼɦǟʊֆȶ ǟʟʟ օʄ
ȶɦɛ ֆʏֆȶɛʍ'ֆ ʍɛʍօʀʏ. Ӈօաɛʋɛʀ ɨռ օʀɖɛʀ ȶօ ǟʋօɨɖ ֆʊɮȶʟɛ ƈօʀռɛʀ ƈǟֆɛֆ աɦɛʀɛ ֆօʍɛօռɛ
ʀɛɨռȶɛʀքʀɛȶֆ ֆօʍɛ ǟʀʀǟʏ օʄ `< ɨֆɨʐɛ::ⱮǞҲ` օɮʝɛƈȶֆ ǟֆ ɮʏȶɛֆ, ֆȶɖ ʟɨʍɨȶֆ ǟʟʟ
ǟʟʟօƈǟȶɨօռֆ ȶօ `ɨֆɨʐɛ::ⱮǞҲ` ɮʏȶɛֆ.

Øռ ǟʟʟ 64-ɮɨȶ ȶǟʀɢɛȶֆ ȶɦǟȶ Ʀʊֆȶ ƈʊʀʀɛռȶʟʏ ֆʊքքօʀȶֆ աɛ'ʀɛ ǟʀȶɨʄɨƈɨǟʟʟʏ ʟɨʍɨȶɛɖ
ȶօ ֆɨɢռɨʄɨƈǟռȶʟʏ ʟɛֆֆ ȶɦǟռ ǟʟʟ 64 ɮɨȶֆ օʄ ȶɦɛ ǟɖɖʀɛֆֆ ֆքǟƈɛ (ʍօɖɛʀռ Ӽ64
քʟǟȶʄօʀʍֆ օռʟʏ ɛӼքօֆɛ 48-ɮɨȶ ǟɖɖʀɛֆֆɨռɢ), ֆօ աɛ ƈǟռ ʀɛʟʏ օռ ʝʊֆȶ ʀʊռռɨռɢ օʊȶ օʄ
ʍɛʍօʀʏ ʄɨʀֆȶ. Ӈօաɛʋɛʀ օռ 32-ɮɨȶ ȶǟʀɢɛȶֆ, քǟʀȶɨƈʊʟǟʀʟʏ ȶɦօֆɛ աɨȶɦ ɛӼȶɛռֆɨօռֆ ȶօ
ʊֆɛ ʍօʀɛ օʄ ȶɦɛ ǟɖɖʀɛֆֆ ֆքǟƈɛ (ՔǞƐ Ӽ86 օʀ Ӽ32), ɨȶ'ֆ ȶɦɛօʀɛȶɨƈǟʟʟʏ քօֆֆɨɮʟɛ ȶօ
ֆʊƈƈɛֆֆʄʊʟʟʏ ǟʟʟօƈǟȶɛ ʍօʀɛ ȶɦǟռ `ɨֆɨʐɛ::ⱮǞҲ` ɮʏȶɛֆ օʄ ʍɛʍօʀʏ.

Ӈօաɛʋɛʀ ֆɨռƈɛ ȶɦɨֆ ɨֆ ǟ ȶʊȶօʀɨǟʟ, աɛ'ʀɛ ռօȶ ɢօɨռɢ ȶօ ɮɛ քǟʀȶɨƈʊʟǟʀʟʏ օքȶɨʍǟʟ
ɦɛʀɛ, ǟռɖ ʝʊֆȶ ʊռƈօռɖɨȶɨօռǟʟʟʏ ƈɦɛƈӄ, ʀǟȶɦɛʀ ȶɦǟռ ʊֆɛ ƈʟɛʋɛʀ քʟǟȶʄօʀʍ-ֆքɛƈɨʄɨƈ
`ƈʄɢ`ֆ.

Ƭɦɛ օȶɦɛʀ ƈօʀռɛʀ-ƈǟֆɛ աɛ ռɛɛɖ ȶօ աօʀʀʏ ǟɮօʊȶ ɨֆ ɛʍքȶʏ ǟʟʟօƈǟȶɨօռֆ. Ƭɦɛʀɛ աɨʟʟ
ɮɛ ȶաօ ӄɨռɖֆ օʄ ɛʍքȶʏ ǟʟʟօƈǟȶɨօռֆ աɛ ռɛɛɖ ȶօ աօʀʀʏ ǟɮօʊȶ: `ƈǟք = 0` ʄօʀ ǟʟʟ Ƭ,
ǟռɖ `ƈǟք > 0` ʄօʀ ʐɛʀօ-ֆɨʐɛɖ ȶʏքɛֆ.

Ƭɦɛֆɛ ƈǟֆɛֆ ǟʀɛ ȶʀɨƈӄʏ ɮɛƈǟʊֆɛ ȶɦɛʏ ƈօʍɛ
ɖօառ ȶօ աɦǟȶ ŁŁƲⱮ ʍɛǟռֆ ɮʏ "ǟʟʟօƈǟȶɛɖ". ŁŁƲⱮ'ֆ ռօȶɨօռ օʄ ǟռ
ǟʟʟօƈǟȶɨօռ ɨֆ ֆɨɢռɨʄɨƈǟռȶʟʏ ʍօʀɛ ǟɮֆȶʀǟƈȶ ȶɦǟռ ɦօա աɛ ʊֆʊǟʟʟʏ ʊֆɛ ɨȶ. Ɓɛƈǟʊֆɛ
ŁŁƲⱮ ռɛɛɖֆ ȶօ աօʀӄ աɨȶɦ ɖɨʄʄɛʀɛռȶ ʟǟռɢʊǟɢɛֆ' ֆɛʍǟռȶɨƈֆ ǟռɖ ƈʊֆȶօʍ ǟʟʟօƈǟȶօʀֆ,
ɨȶ ƈǟռ'ȶ ʀɛǟʟʟʏ ɨռȶɨʍǟȶɛʟʏ ʊռɖɛʀֆȶǟռɖ ǟʟʟօƈǟȶɨօռ. Ɨռֆȶɛǟɖ, ȶɦɛ ʍǟɨռ ɨɖɛǟ ɮɛɦɨռɖ
ǟʟʟօƈǟȶɨօռ ɨֆ "ɖօɛֆռ'ȶ օʋɛʀʟǟք աɨȶɦ օȶɦɛʀ ֆȶʊʄʄ". Ƭɦǟȶ ɨֆ, ɦɛǟք ǟʟʟօƈǟȶɨօռֆ,
ֆȶǟƈӄ ǟʟʟօƈǟȶɨօռֆ, ǟռɖ ɢʟօɮǟʟֆ ɖօռ'ȶ ʀǟռɖօʍʟʏ օʋɛʀʟǟք. Ƴɛք, ɨȶ'ֆ ǟɮօʊȶ ǟʟɨǟֆ
ǟռǟʟʏֆɨֆ. Ǟֆ ֆʊƈɦ, Ʀʊֆȶ ƈǟռ ȶɛƈɦռɨƈǟʟʟʏ քʟǟʏ ǟ ɮɨȶ ʄǟֆȶ ǟռɖ ʟօօֆɛ աɨȶɦ ȶɦɛ ռօȶɨօռ օʄ
ǟռ ǟʟʟօƈǟȶɨօռ ǟֆ ʟօռɢ ǟֆ ɨȶ'ֆ *ƈօռֆɨֆȶɛռȶ*.

Ɠɛȶȶɨռɢ ɮǟƈӄ ȶօ ȶɦɛ ɛʍքȶʏ ǟʟʟօƈǟȶɨօռ ƈǟֆɛ, ȶɦɛʀɛ ǟʀɛ ǟ ƈօʊքʟɛ օʄ քʟǟƈɛֆ աɦɛʀɛ
աɛ աǟռȶ ȶօ օʄʄֆɛȶ ɮʏ 0 ǟֆ ǟ ƈօռֆɛզʊɛռƈɛ օʄ ɢɛռɛʀɨƈ ƈօɖɛ. Ƭɦɛ զʊɛֆȶɨօռ ɨֆ ȶɦɛռ:
ɨֆ ɨȶ ƈօռֆɨֆȶɛռȶ ȶօ ɖօ ֆօ? Ƒօʀ ʐɛʀօ-ֆɨʐɛɖ ȶʏքɛֆ, աɛ ɦǟʋɛ ƈօռƈʟʊɖɛɖ ȶɦǟȶ ɨȶ ɨֆ
ɨռɖɛɛɖ ƈօռֆɨֆȶɛռȶ ȶօ ɖօ ǟ ƓƐՔ ɨռɮօʊռɖֆ օʄʄֆɛȶ ɮʏ ǟռ ǟʀɮɨȶʀǟʀʏ ռʊʍɮɛʀ օʄ
ɛʟɛʍɛռȶֆ. Ƭɦɨֆ ɨֆ ǟ ʀʊռȶɨʍɛ ռօ-օք ɮɛƈǟʊֆɛ ɛʋɛʀʏ ɛʟɛʍɛռȶ ȶǟӄɛֆ ʊք ռօ ֆքǟƈɛ,
ǟռɖ ɨȶ'ֆ ʄɨռɛ ȶօ քʀɛȶɛռɖ ȶɦǟȶ ȶɦɛʀɛ'ֆ ɨռʄɨռɨȶɛ ʐɛʀօ-ֆɨʐɛɖ ȶʏքɛֆ ǟʟʟօƈǟȶɛɖ
ǟȶ `0Ӽ01`. Ռօ ǟʟʟօƈǟȶօʀ աɨʟʟ ɛʋɛʀ ǟʟʟօƈǟȶɛ ȶɦǟȶ ǟɖɖʀɛֆֆ, ɮɛƈǟʊֆɛ ȶɦɛʏ աօռ'ȶ
ǟʟʟօƈǟȶɛ `0Ӽ00` ǟռɖ ȶɦɛʏ ɢɛռɛʀǟʟʟʏ ǟʟʟօƈǟȶɛ ȶօ ֆօʍɛ ʍɨռɨʍǟʟ ǟʟɨɢռʍɛռȶ ɦɨɢɦɛʀ
ȶɦǟռ ǟ ɮʏȶɛ. Ǟʟֆօ ɢɛռɛʀǟʟʟʏ ȶɦɛ աɦօʟɛ ʄɨʀֆȶ քǟɢɛ օʄ ʍɛʍօʀʏ ɨֆ
քʀօȶɛƈȶɛɖ ʄʀօʍ ɮɛɨռɢ ǟʟʟօƈǟȶɛɖ ǟռʏաǟʏ (ǟ աɦօʟɛ 4ӄ, օռ ʍǟռʏ քʟǟȶʄօʀʍֆ).

Ӈօաɛʋɛʀ աɦǟȶ ǟɮօʊȶ ʄօʀ քօֆɨȶɨʋɛ-ֆɨʐɛɖ ȶʏքɛֆ? Ƭɦǟȶ օռɛ'ֆ ǟ ɮɨȶ ȶʀɨƈӄɨɛʀ. Ɨռ
քʀɨռƈɨքʟɛ, ʏօʊ ƈǟռ ǟʀɢʊɛ ȶɦǟȶ օʄʄֆɛȶȶɨռɢ ɮʏ 0 ɢɨʋɛֆ ŁŁƲⱮ ռօ ɨռʄօʀʍǟȶɨօռ: ɛɨȶɦɛʀ
ȶɦɛʀɛ'ֆ ǟռ ɛʟɛʍɛռȶ ɮɛʄօʀɛ ȶɦɛ ǟɖɖʀɛֆֆ օʀ ǟʄȶɛʀ ɨȶ, ɮʊȶ ɨȶ ƈǟռ'ȶ ӄռօա աɦɨƈɦ.
Ӈօաɛʋɛʀ աɛ'ʋɛ ƈɦօֆɛռ ȶօ ƈօռֆɛʀʋǟȶɨʋɛʟʏ ǟֆֆʊʍɛ ȶɦǟȶ ɨȶ ʍǟʏ ɖօ ɮǟɖ ȶɦɨռɢֆ. Ǟֆ
ֆʊƈɦ աɛ աɨʟʟ ɢʊǟʀɖ ǟɢǟɨռֆȶ ȶɦɨֆ ƈǟֆɛ ɛӼքʟɨƈɨȶʟʏ.

*Քɦɛա*

Øӄ աɨȶɦ ǟʟʟ ȶɦɛ ռօռֆɛռֆɛ օʊȶ օʄ ȶɦɛ աǟʏ, ʟɛȶ'ֆ ǟƈȶʊǟʟʟʏ ǟʟʟօƈǟȶɛ ֆօʍɛ ʍɛʍօʀʏ:

<!-- ignore: simplified code -->
```rust,ignore
use std::alloc::{self, Layout};

impl<T> Vec<T> {
    fn grow(&mut self) {
        let (new_cap, new_layout) = if self.cap == 0 {
            (1, Layout::array::<T>(1))
        } else {
            // This can't overflow since self.cap <= isize::MAX.
            let new_cap = 2 * self.cap;
            (new_cap, Layout::array::<T>(new_cap))
        };

        // `Layout::array` checks that the number of bytes allocated is
        // in 1..=isize::MAX and will error otherwise.  An allocation of
        // 0 bytes isn't possible thanks to the above condition.
        let new_layout = new_layout.expect("Allocation too large");

        let new_ptr = if self.cap == 0 {
            unsafe { alloc::alloc(new_layout) }
        } else {
            let old_layout = Layout::array::<T>(self.cap).unwrap();
            let old_ptr = self.ptr.as_ptr() as *mut u8;
            unsafe { alloc::realloc(old_ptr, old_layout, new_layout.size()) }
        };

        // If allocation fails, `new_ptr` will be null, in which case we abort.
        self.ptr = match NonNull::new(new_ptr as *mut T) {
            Some(p) => p,
            None => alloc::handle_alloc_error(new_layout),
        };
        self.cap = new_cap;
    }
}
# fn main() {}
```

[Ɠʟօɮǟʟ]: ../../std/alloc/struct.Global.html
[ɦǟռɖʟɛ_ǟʟʟօƈ_ɛʀʀօʀ]: ../../alloc/alloc/fn.handle_alloc_error.html
[ǟʟʟօƈ]: ../../alloc/alloc/fn.alloc.html
[ʀɛǟʟʟօƈ]: ../../alloc/alloc/fn.realloc.html
[ɖɛǟʟʟօƈ]: ../../alloc/alloc/fn.dealloc.html
[ֆȶɖ_ǟʟʟօƈ]: ../../alloc/alloc/index.html
